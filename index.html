<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- This meta tag makes the app responsive on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DXF Parser</title>
  <!-- Include JSZip for ZIP file browsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js">
  </script>
  <!-- Use style-enabled XLSX build to support cell background colors in exports -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
  <!-- Load components in dependency order -->
  <script src="components/utils.js"></script>
  <script src="components/dxf-parser.js"></script>
  <script src="components/rendering-entities.js"></script>
  <script src="components/rendering-scene-graph.js"></script>
  <script src="components/rendering-document-builder.js"></script>
  <script src="components/rendering-data-controller.js"></script>
  <script src="components/rendering-surface-canvas.js"></script>
  <script src="components/rendering-surface-webgl.js"></script>
  <script src="components/rendering-text-layout.js"></script>
  <script src="components/rendering-renderer.js"></script>
  <script src="components/rendering-overlay.js"></script>
  <script src="components/tree-data-grid.js"></script>
  <script src="components/batch-data-grid.js"></script>
  <script src="components/state-manager.js"></script>
  <script src="components/tree-diff-engine.js"></script>
  <script src="components/dxf-diagnostics-engine.js"></script>
  <script src="components/app.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="main-container">
    <!-- Top Header spanning sidebar and main content -->
    <div class="top-header">
      <div class="top-header-left">
        <button id="toggleSidebarBtn" class="sidebar-toggle" title="Show/Hide sidebar" aria-label="Toggle sidebar" aria-pressed="false">‚ò∞</button>
        <div class="app-title">DXF Parser</div>
        <span id="diffIndicator" class="diff-indicator" title="Tree Diff enabled" style="display:none;"></span>
        <!-- Diff navigation buttons (visible only in Tree Diff mode) -->
        <div id="diffNavButtons" style="display:none; gap:4px; margin-left:8px;">
          <button id="nextAdditionBtn" class="icon-button has-tooltip" title="Next addition block" aria-label="Next addition block" data-tooltip="Next addition block">‚ûï</button>
          <button id="nextRemovalBtn" class="icon-button has-tooltip" title="Next removal block" aria-label="Next removal block" data-tooltip="Next removal block">‚ûñ</button>
          <button id="nextChangeBtn" class="icon-button has-tooltip" title="Next data change block" aria-label="Next data change block" data-tooltip="Next data change block">‚ú≥Ô∏è</button>
        </div>
      </div>
      <div class="top-header-right">
        <label class="has-tooltip" title="Use streamed parsing" data-tooltip="Use streamed parsing for DXF files (lower memory usage)">
          <input type="checkbox" id="useStreamCheckbox" aria-label="Use streamed parsing">
          Use Streamed Parsing
        </label>
        <button id="toggleRightPanelBtn" class="icon-button has-tooltip" title="Toggle Right Panel" aria-label="Toggle Right Panel" data-tooltip="Toggle Right Panel"><span aria-hidden="true">‚ÜîÔ∏è</span></button>
        <button id="createNewDxfBtn" class="icon-button has-tooltip" title="Create New DXF" aria-label="Create New DXF" data-tooltip="Create New DXF"><span aria-hidden="true">üÜï</span></button>
        <button id="resetStateBtn" class="icon-button has-tooltip" title="Reset State" aria-label="Reset State" data-tooltip="Reset State"><span aria-hidden="true">üîÑ</span></button>
        <button id="saveStateToFileBtn" class="icon-button has-tooltip" title="Save State to File" aria-label="Save State to File" data-tooltip="Save State to File"><span aria-hidden="true">üíæ</span></button>
        <button id="loadStateFromFileBtn" class="icon-button has-tooltip" title="Load State from File" aria-label="Load State from File" data-tooltip="Load State from File"><span aria-hidden="true">üìÇ</span></button>
        <input type="file" id="appStateFileInput" accept=".json" style="display:none">
      </div>
    </div>
    <!-- Main content wrapper with sidebar and main content -->
    <div class="content-wrapper">
      <!-- Sidebar: Contains logo, header buttons and filter panel -->
      <div class="sidebar">
        <button id="closeSidebarBtn" class="close-sidebar-btn icon-button" title="Close" aria-label="Close sidebar">‚úñ</button>
        <div class="sidebar-buttons">
          <button id="showCloudOverlayBtn" class="fluent-button has-tooltip" title="Cloud Data" data-tooltip="Cloud Data"><span class="fluent-icon" aria-hidden="true">‚òÅÔ∏è</span><span>Cloud Data</span></button>
          <button id="showStatsOverlayBtn" class="fluent-button has-tooltip" title="Statistics" data-tooltip="Statistics"><span class="fluent-icon" aria-hidden="true">üìä</span><span>Statistics</span></button>
          <button id="showDepsOverlayBtn" class="fluent-button has-tooltip" title="Dependencies" data-tooltip="Dependencies"><span class="fluent-icon" aria-hidden="true">üîó</span><span>Dependencies</span></button>
          <button id="showBinaryObjectsOverlayBtn" class="fluent-button has-tooltip" title="Binary Objects" data-tooltip="Binary Objects"><span class="fluent-icon" aria-hidden="true">üß±</span><span>Binary Objects</span></button>
          <button id="showHandleMapOverlayBtn" class="fluent-button has-tooltip" title="Handle Map" data-tooltip="Handle Map"><span class="fluent-icon" aria-hidden="true">üó∫Ô∏è</span><span>Handle Map</span></button>
          <button id="showProxyObjectsOverlayBtn" class="fluent-button has-tooltip" title="Proxy Objects" data-tooltip="Proxy Objects"><span class="fluent-icon" aria-hidden="true">ü™û</span><span>Proxy Objects</span></button>
          <button id="showFontsOverlayBtn" class="fluent-button has-tooltip" title="Fonts Used" data-tooltip="Fonts Used"><span class="fluent-icon" aria-hidden="true">üî§</span><span>Fonts Used</span></button>
          <button id="showClassesOverlayBtn" class="fluent-button has-tooltip" title="Classes" data-tooltip="Classes"><span class="fluent-icon" aria-hidden="true">üè∑Ô∏è</span><span>Classes</span></button>
          <button id="showObjectSizeOverlayBtn" class="fluent-button has-tooltip" title="Object Sizes" data-tooltip="Object Sizes"><span class="fluent-icon" aria-hidden="true">üìè</span><span>Object Sizes</span></button>
          <button id="showBlocksOverlayBtn" class="fluent-button has-tooltip" title="Blocks &amp; Inserts" data-tooltip="Blocks &amp; Inserts"><span class="fluent-icon" aria-hidden="true">üß©</span><span>Blocks &amp; Inserts</span></button>
          <button id="showLineTypesOverlayBtn" class="fluent-button has-tooltip" title="Line Types" data-tooltip="Line Types"><span class="fluent-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><line x1="1" y1="4" x2="15" y2="4" stroke="currentColor" stroke-width="1.5"/><line x1="1" y1="8" x2="15" y2="8" stroke="currentColor" stroke-width="1.5" stroke-dasharray="3 2"/><line x1="1" y1="12" x2="15" y2="12" stroke="currentColor" stroke-width="1.5" stroke-dasharray="1 2"/></svg></span><span>Line Types</span></button>
          <button id="showTextsOverlayBtn" class="fluent-button has-tooltip" title="Texts" data-tooltip="Texts"><span class="fluent-icon" aria-hidden="true">‚úé</span><span>Texts</span></button>
          <button id="showDiagnosticsOverlayBtn" class="fluent-button has-tooltip" title="Diagnostics" data-tooltip="Diagnostics"><span class="fluent-icon" aria-hidden="true">ü©∫</span><span>Diagnostics</span></button>
          <button id="showBatchProcessOverlayBtn" class="fluent-button has-tooltip" title="Batch Process" data-tooltip="Batch Process"><span class="fluent-icon" aria-hidden="true">üß∞</span><span>Batch Process</span></button>
          <button id="toggleSideBySideDiffBtn" class="fluent-button has-tooltip" title="Tree Diff" data-tooltip="Tree Diff"><span class="fluent-icon" aria-hidden="true">‚áÑ</span><span>Tree Diff</span></button>
        </div>
        <div class="filter-panel" id="filterPanel" style="display:none;"></div>
      </div>
      
      <!-- Main Content Area -->
      <div class="main-content">
        <!-- Row: global controls and split load buttons -->
        <div id="rowControls" class="row-controls">
          <div class="row-controls-left">
            <button id="addRowBtn" class="icon-button has-tooltip" title="Add Row" aria-label="Add Row" data-tooltip="Add Row"><span aria-hidden="true">‚ûï</span></button>
            <button id="removeRowBtn" class="icon-button has-tooltip" title="Remove Row" aria-label="Remove Row" data-tooltip="Remove Row"><span aria-hidden="true">üóëÔ∏è</span></button>
            <button id="downloadDxfBtn" class="icon-button has-tooltip" title="Download DXF" aria-label="Download DXF" data-tooltip="Download DXF"><span aria-hidden="true">‚¨áÔ∏è</span></button>
            <button id="downloadTreeExcelBtn" class="icon-button has-tooltip" title="Download Tree as Excel" aria-label="Download Tree as Excel" data-tooltip="Download Tree as Excel"><span aria-hidden="true">üìä</span></button>
          </div>
          <div class="row-controls-right">
            <div id="navControls">
              <div id="handleNavBar">
                <input type="text" id="handleSearchInput" placeholder="Go to Handle">
                <button id="goToHandleBtn">Go</button>
              </div>
              <div id="navHistoryContainer">
                <div id="navHistoryControls">
                  <button id="backBtn" disabled>Back</button>
                  <button id="forwardBtn" disabled>Forward</button>
                  <button id="clearHistoryBtn">Clear</button>
                </div>
                <div id="navHistoryList"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- Two panel compare layout -->
        <div id="compareContainer" style="display:flex; gap: 8px; height: calc(100% - 60px);">
          <!-- Left Panel -->
          <div class="panel" id="panelLeft" style="flex:1; display:flex; flex-direction:column; min-width:0;">
            <div style="display:flex; align-items:center; gap:6px; margin: 0.25em 0;">
              <div id="tabContainerLeft" class="tab-container" style="flex:1; display:flex; flex-wrap:wrap; border-bottom:1px solid #ccc; margin:0.25em 0;"></div>
              <input type="file" id="fileInputLeft" accept=".dxf" multiple style="display:none">
              <button id="openLeftBtn" title="Open DXF on left">Open</button>
              <button id="renderOverlayLeftBtn" class="icon-button has-tooltip" title="Render DXF" aria-label="Render DXF overlay" data-tooltip="Open DXF rendering overlay">
                <span aria-hidden="true">üé®</span>
              </button>
              <button id="expandAllLeftBtn" class="icon-button has-tooltip" title="Expand All" aria-label="Expand All" data-tooltip="Expand all nodes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 10l5 5 5-5H7z"/></svg>
              </button>
              <button id="collapseAllLeftBtn" class="icon-button has-tooltip" title="Collapse All" aria-label="Collapse All" data-tooltip="Collapse all nodes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 14l5-5 5 5H7z"/></svg>
              </button>
              <button id="filtersLeftBtn" class="icon-button filters-button has-tooltip" title="Filters" aria-label="Filters" data-tooltip="Open filters">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 5h18l-7 8v6l-4-2v-4L3 5z"/></svg>
              </button>
            </div>
            <div id="treeGridHeaderLeft" class="tree-header">
              <div class="tree-line header-cell flex-fixed" data-field="line" data-sort="none" style="width: 130px; text-align: left;">
                Line <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-code header-cell flex-fixed" data-field="code" data-sort="none" style="width: 100px; text-align: left;">
                Code <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-data header-cell flex-grow" data-field="type" data-sort="none" style="flex: 1;">
                Data <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-object-count header-cell flex-fixed" data-field="objectCount" data-sort="none" style="width: 130px; text-align: right;">
                Object Count <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-data-size header-cell flex-fixed" data-field="dataSize" data-sort="none" style="width: 130px; text-align: right;">
                Data Size <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
            </div>
            <div id="treeViewContainerLeft" style="position: relative; flex:1; overflow:auto; border:1px solid #ccc; clip-path: inset(0);">
              <div id="treeViewContentLeft" style="position: relative; overflow: hidden;"></div>
            </div>
          </div>
          <!-- Splitter between panels -->
          <div id="compareSplitter" class="compare-splitter" style="width:6px; cursor: ew-resize; background:#ccc; flex: none;"></div>
          <!-- Right Panel -->
          <div class="panel" id="panelRight" style="flex:1; display:flex; flex-direction:column; min-width:0;">
            <div style="display:flex; align-items:center; gap:6px; margin: 0.25em 0;">
              <div id="tabContainerRight" class="tab-container" style="flex:1; display:flex; flex-wrap:wrap; border-bottom:1px solid #ccc; margin:0.25em 0;"></div>
              <input type="file" id="fileInputRight" accept=".dxf" multiple style="display:none">
              <button id="openRightBtn" title="Open DXF on right">Open</button>
              <button id="renderOverlayRightBtn" class="icon-button has-tooltip" title="Render DXF" aria-label="Render DXF overlay (right)" data-tooltip="Open DXF rendering overlay">
                <span aria-hidden="true">üé®</span>
              </button>
              <button id="expandAllRightBtn" class="icon-button has-tooltip" title="Expand All" aria-label="Expand All" data-tooltip="Expand all nodes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 10l5 5 5-5H7z"/></svg>
              </button>
              <button id="collapseAllRightBtn" class="icon-button has-tooltip" title="Collapse All" aria-label="Collapse All" data-tooltip="Collapse all nodes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 14l5-5 5 5H7z"/></svg>
              </button>
              <button id="filtersRightBtn" class="icon-button filters-button has-tooltip" title="Filters" aria-label="Filters" data-tooltip="Open filters">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 5h18l-7 8v6l-4-2v-4L3 5z"/></svg>
              </button>
            </div>
            <div id="treeGridHeaderRight" class="tree-header">
              <div class="tree-line header-cell flex-fixed" data-field="line" data-sort="none" style="width: 130px; text-align: left;">
                Line <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-code header-cell flex-fixed" data-field="code" data-sort="none" style="width: 100px; text-align: left;">
                Code <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-data header-cell flex-grow" data-field="type" data-sort="none" style="flex: 1;">
                Data <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-object-count header-cell flex-fixed" data-field="objectCount" data-sort="none" style="width: 130px; text-align: right;">
                Object Count <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-data-size header-cell flex-fixed" data-field="dataSize" data-sort="none" style="width: 130px; text-align: right;">
                Data Size <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
            </div>
            <div id="treeViewContainerRight" style="position: relative; flex:1; overflow:auto; border:1px solid #ccc; clip-path: inset(0);">
              <div id="treeViewContentRight" style="position: relative; overflow: hidden;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Backdrop for mobile off-canvas sidebar -->
    <div id="sidebarBackdrop" class="sidebar-backdrop" aria-hidden="true"></div>
  </div>
  <!-- Global tooltip element appended at body level to avoid clipping -->
  <div id="globalTooltip" class="global-tooltip" role="tooltip" aria-hidden="true"></div>
  <!-- DXF Rendering Overlay -->
  <div id="dxfRenderingOverlay" class="filters-overlay" style="display:none;">
    <div class="overlay-content rendering-overlay-content">
      <div class="overlay-header rendering-overlay-header">
        <h2 id="renderingOverlayTitle">DXF Rendering</h2>
        <button id="closeRenderingOverlayBtn" class="close-overlay" title="Close rendering overlay" aria-label="Close">‚úñ</button>
      </div>
      <div class="rendering-overlay-body">
        <div class="rendering-overlay-info">
          <section>
            <h3>Scene Snapshot</h3>
            <div id="renderingOverlaySummary" class="rendering-summary">
              <p>No scene graph loaded.</p>
            </div>
          </section>
          <section>
            <h3>Attribute Visibility</h3>
            <div id="renderingOverlayAttributeControls" class="rendering-attribute-controls">
              <label><input type="checkbox" id="toggleAttributeDefinitions"> Show block attribute definitions</label>
              <label><input type="checkbox" id="toggleAttributeReferences" checked> Show attribute references</label>
              <label><input type="checkbox" id="toggleAttributeInvisible"> Show hidden attributes</label>
            </div>
          </section>
          <section>
            <div class="layer-manager-header">
              <div>
                <h3>Layer Manager</h3>
                <div id="layerManagerStatus" class="layer-manager-status">No layers loaded.</div>
              </div>
              <div class="layer-manager-controls">
                <input type="search" id="layerManagerFilter" placeholder="Filter layers" aria-label="Filter layers">
                <label class="layer-manager-hide-inactive">
                  <input type="checkbox" id="layerManagerHideInactive">
                  Hide off / frozen
                </label>
                <button id="layerManagerReset" type="button">Reset overrides</button>
              </div>
            </div>
            <div id="renderingOverlayLayerManager" class="layer-manager-container">
              <p>No layer metadata available.</p>
            </div>
          </section>
        </div>
        <div class="rendering-overlay-viewport">
          <div id="renderingMeasurementToolbar" class="rendering-measurement-toolbar" role="toolbar" aria-label="Measurement tools">
            <button type="button" class="measurement-tool-btn" data-mode="none" aria-pressed="true" title="Selection mode (hotkey: M)">Select</button>
            <button type="button" class="measurement-tool-btn" data-mode="distance" aria-pressed="false" title="Distance measurement">Distance</button>
            <button type="button" class="measurement-tool-btn" data-mode="area" aria-pressed="false" title="Area measurement">Area</button>
            <button type="button" class="measurement-tool-btn" data-mode="angle" aria-pressed="false" title="Angle measurement">Angle</button>
          </div>
          <div id="renderingSelectionToolbar" class="rendering-selection-toolbar" role="toolbar" aria-label="Selection actions" aria-hidden="true">
            <button type="button" data-action="isolate-layers" title="Isolate layers for selected objects">Isolate Layers</button>
            <button type="button" data-action="lock-layers" title="Lock layers for selected objects">Lock Layers</button>
            <button type="button" data-action="unlock-layers" title="Unlock layers for selected objects">Unlock Layers</button>
            <span class="toolbar-divider" aria-hidden="true"></span>
            <button type="button" data-action="isolate-objects" title="Show only selected objects">Isolate Objects</button>
            <button type="button" data-action="clear-layer-isolation" title="Restore layer visibility">Clear Layer Isolation</button>
            <button type="button" data-action="clear-object-isolation" title="Show all objects">Clear Object Isolation</button>
          </div>
          <div class="rendering-view-overlay">
            <div id="renderingViewCube" class="rendering-view-cube" role="group" aria-label="View cube">
              <button type="button" data-view="home" title="Auto fit view" aria-pressed="false">Home</button>
              <button type="button" data-view="top" title="Top view" aria-pressed="false">Top</button>
              <button type="button" data-view="right" title="Right view" aria-pressed="false">Right</button>
              <button type="button" data-view="bottom" title="Bottom view" aria-pressed="false">Bottom</button>
              <button type="button" data-view="left" title="Left view" aria-pressed="false">Left</button>
              <button type="button" data-view="iso" title="Isometric view" aria-pressed="false">Iso</button>
            </div>
            <div class="rendering-view-history" role="group" aria-label="View history controls">
              <button type="button" id="viewUndoBtn" title="Previous view">Undo</button>
              <button type="button" id="viewHomeBtn" title="Reset to auto view">Home</button>
              <button type="button" id="viewRedoBtn" title="Next view">Redo</button>
            </div>
          </div>
          <div id="renderingNavigationWheel" class="rendering-navigation-wheel" role="group" aria-label="Navigation wheel">
            <button type="button" class="nav-wheel-btn pan-up" data-action="pan-up" title="Pan up">‚Üë</button>
            <button type="button" class="nav-wheel-btn zoom-in" data-action="zoom-in" title="Zoom in">Ôºã</button>
            <button type="button" class="nav-wheel-btn orbit-left" data-action="orbit-left" title="Orbit left">‚ü≤</button>
            <button type="button" class="nav-wheel-btn pan-left" data-action="pan-left" title="Pan left">‚Üê</button>
            <button type="button" class="nav-wheel-btn wheel-home" data-action="home" title="Reset view">‚åÇ</button>
            <button type="button" class="nav-wheel-btn pan-right" data-action="pan-right" title="Pan right">‚Üí</button>
            <button type="button" class="nav-wheel-btn orbit-right" data-action="orbit-right" title="Orbit right">‚ü≥</button>
            <button type="button" class="nav-wheel-btn zoom-out" data-action="zoom-out" title="Zoom out">‚àí</button>
            <button type="button" class="nav-wheel-btn pan-down" data-action="pan-down" title="Pan down">‚Üì</button>
          </div>
          <canvas id="renderingOverlayCanvas"></canvas>
          <div id="renderingOverlayTextLayer" class="rendering-text-layer"></div>
          <div id="renderingOverlayMeasurementLayer" class="rendering-measurement-layer"></div>
          <div id="renderingOverlaySnapLayer" class="rendering-snap-layer"></div>
          <div id="renderingOverlayInteractionLayer" class="rendering-interaction-layer"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- Filters Popup Overlay (Left) -->
  <div id="filtersOverlayLeft" class="filters-overlay" style="display:none;">
    <div class="overlay-content" style="max-width: 520px; max-height: 90vh; overflow:auto;">
      <div class="filter-dialog-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Filters (Left Tab)</h2>
        <button id="closeFiltersOverlayLeft" title="Close">‚úñ</button>
      </div>
      <div class="filter-content">
        <div class="filter-row">
          <div id="codeSearchTagsLeft" class="tag-container">
            <input type="text" id="codeSearchInputLeft" placeholder="Search by Code">
          </div>
        </div>
        <div class="filter-row">
          <div id="dataSearchTagsLeft" class="tag-container">
            <input type="text" id="dataSearchInputLeft" placeholder="Search by Data value">
          </div>
        </div>
        <div class="filter-row">
          <label>Object Types:</label>
          <div id="objectTypeDropdownLeft" class="dropdown">
            <button id="objectTypeDropdownButtonLeft">All Types</button>
            <div id="objectTypeDropdownContentLeft" class="dropdown-content"></div>
          </div>
        </div>
        <div class="filter-row">
          <label><input type="checkbox" id="dataExactCheckboxLeft"> Exact Data Match</label>
        </div>
        <div class="filter-row">
          <label><input type="checkbox" id="dataCaseCheckboxLeft"> Case Sensitive</label>
        </div>
        <div class="filter-row">
          <label for="minLineInputLeft">Min Line:</label>
          <input type="number" id="minLineInputLeft" style="width:80px;">
        </div>
        <div class="filter-row">
          <label for="maxLineInputLeft">Max Line:</label>
          <input type="number" id="maxLineInputLeft" style="width:80px;">
        </div>
        <div class="filter-row">
          <button id="searchBtnLeft">Apply</button>
          <button id="clearSearchBtnLeft">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Popup Overlay (Right) -->
  <div id="filtersOverlayRight" class="filters-overlay" style="display:none;">
    <div class="overlay-content" style="max-width: 520px; max-height: 90vh; overflow:auto;">
      <div class="filter-dialog-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Filters (Right Tab)</h2>
        <button id="closeFiltersOverlayRight" title="Close">‚úñ</button>
      </div>
      <div class="filter-content">
        <div class="filter-row">
          <div id="codeSearchTagsRight" class="tag-container">
            <input type="text" id="codeSearchInputRight" placeholder="Search by Code">
          </div>
        </div>
        <div class="filter-row">
          <div id="dataSearchTagsRight" class="tag-container">
            <input type="text" id="dataSearchInputRight" placeholder="Search by Data value">
          </div>
        </div>
        <div class="filter-row">
          <label>Object Types:</label>
          <div id="objectTypeDropdownRight" class="dropdown">
            <button id="objectTypeDropdownButtonRight">All Types</button>
            <div id="objectTypeDropdownContentRight" class="dropdown-content"></div>
          </div>
        </div>
        <div class="filter-row">
          <label><input type="checkbox" id="dataExactCheckboxRight"> Exact Data Match</label>
        </div>
        <div class="filter-row">
          <label><input type="checkbox" id="dataCaseCheckboxRight"> Case Sensitive</label>
        </div>
        <div class="filter-row">
          <label for="minLineInputRight">Min Line:</label>
          <input type="number" id="minLineInputRight" style="width:80px;">
        </div>
        <div class="filter-row">
          <label for="maxLineInputRight">Max Line:</label>
          <input type="number" id="maxLineInputRight" style="width:80px;">
        </div>
        <div class="filter-row">
          <button id="searchBtnRight">Apply</button>
          <button id="clearSearchBtnRight">Clear</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Overlays -->
  <div id="cloudOverlay">
    <div class="overlay-content">
      <button id="closeCloudOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="cloudOverlay">Back to Tree</button>
      <h2>Cloud Data</h2>
      <h3>Object Cloud</h3>
      <div id="overlayObjectCloud"></div>
      <h3>Code Cloud</h3>
      <div id="overlayCodeCloud"></div>
    </div>
  </div>
  <div id="statsOverlay">
    <div class="overlay-content">
      <button id="closeStatsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="statsOverlay">Back to Tree</button>
      <h2>DXF Statistics</h2>
      <div id="overlayStatsContent"></div>
    </div>
  </div>
  <div id="depsOverlay">
    <div class="overlay-content">
      <button id="closeDepsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="depsOverlay">Back to Tree</button>
      <h2>DXF Dependencies</h2>
      <div id="overlayDepsContent"></div>
    </div>
  </div>
  <div id="hexViewerOverlay">
    <div class="overlay-content">
      <button id="closeHexViewerOverlay">Close</button>
      <button id="saveBinaryBtn">Save Binary</button>
      <button id="previewImageBtn">Preview Image</button>
      <h2>Hex Viewer</h2>
      <div id="headerInfo"></div>
      <pre id="hexContent" style="overflow:auto; height: calc(100% - 160px);"></pre>
      <div id="imagePreviewContainer"></div>
      <div id="zipContentsContainer"></div>
    </div>
  </div>
  <div id="binaryObjectsOverlay">
    <div class="overlay-content">
      <button id="closeBinaryObjectsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="binaryObjectsOverlay">Back to Tree</button>
      <h2>Binary Data Objects</h2>
      <div id="binaryObjectsList"></div>
    </div>
  </div>
  <div id="handleMapOverlay">
    <div class="overlay-content">
      <button id="closeHandleMapOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="handleMapOverlay">Back to Tree</button>
      <h2>DXF Handle Map</h2>
      <div id="overlayHandleMapContent"></div>
    </div>
  </div>
  <div id="proxyObjectsOverlay">
    <div class="overlay-content">
      <button id="closeProxyObjectsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="proxyObjectsOverlay">Back to Tree</button>
      <h2>Proxy Objects</h2>
      <div id="proxyObjectsList"></div>
    </div>
  </div>
  <div id="fontsOverlay">
    <div class="overlay-content">
      <button id="closeFontsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="fontsOverlay">Back to Tree</button>
      <h2>Fonts Used in DXF</h2>
      <div id="overlayFontsContent"></div>
    </div>
  </div>
  <div id="classesOverlay">
    <div class="overlay-content">
      <button id="closeClassesOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="classesOverlay">Back to Tree</button>
      <h2>DXF Classes</h2>
      <div id="overlayClassesContent"></div>
    </div>
  </div>
  <div id="diagnosticsOverlay">
    <div class="overlay-content">
      <div class="diagnostics-header">
        <div class="diagnostics-header-left">
          <h2>DXF Comprehensive Diagnostics</h2>
          <button id="configureRulesBtn">Configure Rules</button>
        </div>
        <div class="diagnostics-header-right">
          <button id="runDiagnosticsBtn">Run Analysis</button>
          <button id="exportDiagnosticsBtn">Export Report</button>
          <button id="closeDiagnosticsOverlay">Close</button>
        </div>
      </div>
      
      <div class="diagnostics-progress" id="diagnosticsProgress" style="display:none;">
        <div class="diagnostics-progress-bar">
          <div class="diagnostics-progress-fill" id="diagnosticsProgressFill" style="width: 0%;"></div>
        </div>
        <div id="diagnosticsProgressText">Initializing diagnostics...</div>
      </div>

      <div class="diagnostics-summary" id="diagnosticsSummary" style="display:none;">
        <div class="diagnostics-stats" id="diagnosticsStats"></div>
        
        <!-- Advanced Search and Filtering -->
        <div class="diagnostics-filters" id="diagnosticsFilters">
          <div class="diagnostics-filter-row">
            <div class="diagnostics-search-container">
              <input type="text" id="diagnosticsSearchInput" placeholder="Search issues... (Ctrl+F)" title="Search in issue titles and descriptions. Use Ctrl+F to focus, Escape to clear." />
              <button id="clearDiagnosticsSearch" title="Clear search">Clear</button>
            </div>
            <div class="diagnostics-severity-filters">
              <label title="Press 1 to filter Critical issues only"><input type="checkbox" id="filterCritical" checked> Critical</label>
              <label title="Press 2 to filter Error issues only"><input type="checkbox" id="filterError" checked> Error</label>
              <label title="Press 3 to filter Warning issues only"><input type="checkbox" id="filterWarning" checked> Warning</label>
              <label title="Press 4 to filter Info issues only"><input type="checkbox" id="filterInfo" checked> Info</label>
              <label title="Press 5 to filter Suggestion issues only"><input type="checkbox" id="filterSuggestion" checked> Suggestion</label>
            </div>
            <div class="diagnostics-category-filters">
              <select id="diagnosticsCategoryFilter" title="Filter by diagnostic category">
                <option value="">All Categories</option>
                <option value="structural">Structural Issues</option>
                <option value="integrity">Data Integrity</option>
                <option value="rendering">Rendering</option>
                <option value="text">Text</option>
                <option value="performance">Performance</option>
                <option value="compliance">DXF Compliance</option>
                <option value="best-practices">Best Practices</option>
                <option value="security">Security</option>
              </select>
            </div>
          </div>
                <div class="diagnostics-help-text" style="font-size: 0.8em; color: #666; margin-top: 0.5em;">
        üí° <strong>Quick Tips:</strong> Ctrl+F to search, 1-5 keys for severity filters, Ctrl+E to export, click statistics to filter by severity
      </div>
    </div>


      <div class="diagnostics-tabs" id="diagnosticsTabs">
        <div class="diagnostics-tab active" data-tab="overview">Overview</div>
        <div class="diagnostics-tab" data-tab="structural">Structural Issues</div>
        <div class="diagnostics-tab" data-tab="integrity">Data Integrity</div>
        <div class="diagnostics-tab" data-tab="rendering">Rendering</div>
        <div class="diagnostics-tab" data-tab="text">Text</div>
        <div class="diagnostics-tab" data-tab="performance">Performance</div>
        <div class="diagnostics-tab" data-tab="compliance">DXF Compliance</div>
        <div class="diagnostics-tab" data-tab="best-practices">Best Practices</div>
        <div class="diagnostics-tab" data-tab="security">Security</div>
      </div>

      <div id="diagnosticsTabContent">
        <div class="diagnostics-content active" id="diagnostics-overview">
          <div id="diagnosticsOverviewContent">
            <p>Click "Run Analysis" to start comprehensive DXF diagnostics analysis...</p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-structural">
          <div id="diagnosticsStructuralContent">
            <p><em>No structural issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-integrity">
          <div id="diagnosticsIntegrityContent">
            <p><em>No data integrity issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-rendering">
          <div id="diagnosticsRenderingContent">
            <p><em>No rendering issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-text">
          <div id="diagnosticsTextContent">
            <p><em>No text issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-performance">
          <div id="diagnosticsPerformanceContent">
            <p><em>No performance issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-compliance">
          <div id="diagnosticsComplianceContent">
            <p><em>No compliance issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-best-practices">
          <div id="diagnosticsBestPracticesContent">
            <p><em>No best practice violations found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-security">
          <div id="diagnosticsSecurityContent">
            <p><em>No security issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Rule Configuration Dialog - Separate overlay rendered above diagnostics -->
  <div id="ruleConfigOverlay">
    <div class="overlay-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; margin: 20px auto;">
      <div class="overlay-header">
        <h2>Configure Diagnostic Rules</h2>
        <button class="close-overlay" id="closeRuleConfigBtn">&times;</button>
      </div>
      
      <div class="rule-config-toolbar">
        <div class="rule-config-actions">
          <button id="selectAllRulesBtn">Select All</button>
          <button id="deselectAllRulesBtn">Deselect All</button>
          <button id="resetToDefaultRulesBtn">Reset to Default</button>
        </div>
        
        <div class="rule-profiles">
          <select id="ruleProfileSelect">
            <option value="">Select Profile...</option>
          </select>
          <button id="saveRuleProfileBtn">Save Profile</button>
          <button id="loadRuleProfileBtn">Load Profile</button>
          <button id="deleteRuleProfileBtn">Delete Profile</button>
          <button id="clearAllProfilesBtn">Clear All Profiles</button>
          <button id="saveProfileToFileBtn">Save to File</button>
          <button id="loadProfileFromFileBtn">Load from File</button>
          <input type="file" id="profileFileInput" accept=".json" style="display: none;">
        </div>
        
        <div class="rule-search">
          <input type="text" id="ruleSearchInput" placeholder="Search rules..." />
        </div>
      </div>
      
      <div class="rule-config-content" id="ruleConfigContent">
        <!-- Rule categories will be populated dynamically -->
      </div>
      
      <div class="overlay-footer">
        <button id="applyRuleConfigBtn" class="primary">Apply Configuration</button>
        <button id="cancelRuleConfigBtn">Cancel</button>
      </div>
    </div>
  </div>
</div>
  
  <div id="objectSizeOverlay">
    <div class="overlay-content">
      <button id="closeObjectSizeOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="objectSizeOverlay">Back to Tree</button>
      <h2>Object Sizes</h2>
      <!-- The container that will be virtualized -->
      <div id="objectSizeList" style="overflow-y:auto; height: calc(100% - 60px); border:1px solid #ccc; margin-top:40px;"></div>
    </div>
  </div>
  <div id="blocksOverlay">
    <div class="overlay-content">
      <button id="closeBlocksOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="blocksOverlay">Back to Tree</button>
      <h2>Block &amp; Insert Relations</h2>
      <div id="overlayBlocksContent"></div>
    </div>
  </div>
  <div id="lineTypesOverlay">
    <div class="overlay-content">
      <button id="closeLineTypesOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="lineTypesOverlay">Back to Tree</button>
      <h2>DXF Line Types</h2>
      <div id="overlayLineTypesContent"></div>
    </div>
  </div>
  <div id="textsOverlay">
    <div class="overlay-content">
      <button id="closeTextsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="textsOverlay">Back to Tree</button>
      <h2>DXF Texts</h2>
      <div id="overlayTextsContent"></div>
    </div>
  </div>
  <div id="batchProcessingOverlay">
    <div class="overlay-content" style="display: flex; flex-direction: column; gap: 0.5em; position: relative;">
      <!-- Close Button -->
      <button id="closeBatchOverlay">Close</button>
      <!-- Title -->
      <h2 style="margin: 0;">Batch Process DXF Files</h2>

      <!-- Search Options: compact grid layout -->
      <div class="batch-search-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin: 0;">
        <!-- Full-width row for directory input -->
        <div style="grid-column: 1 / -1;">
          <label>Select Root Directory:
            <input type="file" id="directoryInput" webkitdirectory directory multiple>
          </label>
        </div>
        <!-- Two-column row: Object Type and Search Code -->
        <div>
          <label>Object Type:
            <input type="text" id="batchObjectType" placeholder="e.g. LINE, CIRCLE">
          </label>
        </div>
        <div>
          <label>Search Code:
            <input type="text" id="batchSearchCode" placeholder="DXF code (optional)">
          </label>
        </div>
        <!-- Two-column row: Search Data and Search Mode -->
        <div>
          <label>Search Data:
            <input type="text" id="batchSearchText" placeholder="Enter search text">
          </label>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5em;">
          <label>
            <input type="radio" name="batchSearchMode" value="contains" checked>
            Contains
          </label>
          <label>
            <input type="radio" name="batchSearchMode" value="exact">
            Exact
          </label>
        </div>

        <!-- Predefined Query Templates Dropdown -->
        <div style="grid-column: 1 / -1;">
          <label>Predefined Query Templates:
            <select id="batchPredefinedQuery">
              <option value="">--Select Template--</option>
              <option value="node => true">All Nodes</option>
              <option value="node => node.type === 'LINE'">All Lines</option>
              <option value="node => node.properties && node.properties.some(p => String(p.code) === '310')">
                Nodes with Code 310
              </option>
              <option value="node => ! (node.properties && node.properties.some(p => String(p.code) === '310'))">
                Nodes without Code 310
              </option>
              <option value="node => (node.type === 'CIRCLE' || node.type === 'ARC')">
                Circles or Arcs
              </option>
              <!-- Filter nodes whose type matches a regex (case-insensitive) -->
              <option value="node => /LINE/i.test(node.type)">
                Nodes with type matching /LINE/i
              </option>
              <!-- Filter nodes that have children with a specific type -->
              <option value="node => node.children && node.children.some(child => child.type === 'BLOCK')">
                Nodes with a Child of type 'BLOCK'
              </option>
              <!-- Filter nodes where any property value matches a regex -->
              <option value="node => node.properties && node.properties.some(p => /circle/i.test(p.value))">
                Nodes with property value matching /circle/i
              </option>
              <!-- Filter nodes that have a child whose property code '2' equals 'INSERT' -->
              <option value="node => node.children && node.children.some(child => child.properties && child.properties.some(p => String(p.code) === '2' && p.value === 'INSERT'))">
                Nodes with Child having property 2 equal to 'INSERT'
              </option>
            </select>
          </label>
        </div>

        <!-- JS Query Input Field -->
        <div style="grid-column: 1 / -1;">
          <label>JavaScript Query:
            <input type="text" id="batchJsQuery" placeholder="e.g. node => node.type === 'LINE'" style="width:100%;">
          </label>
        </div>

        <!-- Full-width row for Start button and progress bar -->
        <div style="grid-column: 1 / -1; display: flex; flex-direction: column; gap: 0.5em;">
          <button id="startBatchProcess">Start Batch Process</button>
          <progress id="batchProgress" value="0" max="100" style="width: 100%; display: none;"></progress>
        </div>
      </div>

      <hr style="margin: 0;">

      <!-- Results Section -->
      <h3 style="margin: 0;">Results</h3>
      <div id="batchResultsTabs" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
        <div id="batchResultsTabHeaders" style="display: flex; border-bottom: 1px solid #ccc;"></div>
        <div id="batchResultsTabContents" style="flex: 1; overflow: auto;"></div>
      </div>

      <!-- Download Button -->
      <div style="text-align: center; margin-top: 0.5em;">
        <button id="downloadExcelBtn">Download as Excel</button>
      </div>
    </div>
  </div>
  

  <!-- Context Menu root (built dynamically in JS) -->
  <nav id="contextMenu" class="menu" role="menu" aria-hidden="true"></nav>

  <!-- Utility Functions -->
  <!-- JavaScript Classes -->
  <!-- TreeDataGrid Control -->
  <!-- BatchDataGrid Control -->
  <!-- Application Code -->
  <script>
    (function() {
      const contentWrapper = document.querySelector('.content-wrapper');
      const toggleBtn = document.getElementById('toggleSidebarBtn');
      const closeBtn = document.getElementById('closeSidebarBtn');
      const backdropEl = document.getElementById('sidebarBackdrop');
      if (!contentWrapper || !toggleBtn) return;

      const sidebarEl = document.querySelector('.sidebar');

      function scheduleGridRelayout() {
        // Prefer calling the app grid directly; fallback to a window resize event
        const run = () => {
          if (window.app) {
            // Run twice to ensure after layout settles
            if (window.app.myTreeGridLeft) {
              window.app.myTreeGridLeft.updateVisibleNodes();
              requestAnimationFrame(() => window.app.myTreeGridLeft.updateVisibleNodes());
            }
            if (window.app.myTreeGridRight) {
              window.app.myTreeGridRight.updateVisibleNodes();
              requestAnimationFrame(() => window.app.myTreeGridRight.updateVisibleNodes());
            }
          } else {
            window.dispatchEvent(new Event('resize'));
          }
        };
        // Give CSS transitions a moment to complete
        setTimeout(run, 0);
        setTimeout(run, 200);
      }

      function setSidebarCollapsed(collapsed) {
        if (collapsed) {
          contentWrapper.classList.add('sidebar-collapsed');
          toggleBtn.setAttribute('aria-pressed', 'true');
          // Let CSS control collapsed width; clear any inline width
          if (sidebarEl) sidebarEl.style.width = '';
          try { localStorage.removeItem('sidebarWidthPx'); } catch (e) {}
        } else {
          contentWrapper.classList.remove('sidebar-collapsed');
          toggleBtn.setAttribute('aria-pressed', 'false');
          // Use natural content width (no persisted width)
          if (sidebarEl) sidebarEl.style.width = '';
          try { localStorage.removeItem('sidebarWidthPx'); } catch (e) {}
        }
        try { localStorage.setItem('sidebarCollapsed', String(collapsed)); } catch (e) {}
        scheduleGridRelayout();
      }

      // Mobile drawer open/close
      function openSidebarDrawer() {
        contentWrapper.classList.add('sidebar-open');
        if (backdropEl) backdropEl.setAttribute('aria-hidden', 'false');
        // Prevent body scroll when open
        document.body.style.overflow = 'hidden';
      }
      function closeSidebarDrawer() {
        contentWrapper.classList.remove('sidebar-open');
        if (backdropEl) backdropEl.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }
      function isMobile() {
        return window.matchMedia && window.matchMedia('(max-width: 600px)').matches;
      }

      // Initialize from saved state (migrate old key if present)
      const savedCollapsed = (function() {
        try {
          const legacy = localStorage.getItem('sidebarHidden');
          if (legacy !== null) {
            const collapsed = legacy === 'true';
            // Migrate and clear legacy key
            localStorage.setItem('sidebarCollapsed', String(collapsed));
            localStorage.removeItem('sidebarHidden');
            return collapsed;
          }
          const newCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
          return newCollapsed;
        } catch (e) { return false; }
      })();
      setSidebarCollapsed(savedCollapsed);

      // Toggle handler
      toggleBtn.addEventListener('click', function(){
        if (isMobile()) {
          // On mobile, act as drawer toggle
          if (contentWrapper.classList.contains('sidebar-open')) {
            closeSidebarDrawer();
          } else {
            openSidebarDrawer();
          }
        } else {
          const willCollapse = !contentWrapper.classList.contains('sidebar-collapsed');
          setSidebarCollapsed(willCollapse);
        }
      });

      // Close button and backdrop handlers (mobile)
      if (closeBtn) closeBtn.addEventListener('click', closeSidebarDrawer);
      if (backdropEl) backdropEl.addEventListener('click', closeSidebarDrawer);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && contentWrapper.classList.contains('sidebar-open')) {
          closeSidebarDrawer();
        }
      });

      // When resizing from mobile to desktop, ensure drawer state doesn't linger
      window.addEventListener('resize', () => {
        if (!isMobile()) {
          closeSidebarDrawer();
        }
      });

      // Also relayout on the end of the sidebar width transition
      if (sidebarEl) {
        sidebarEl.addEventListener('transitionend', (e) => {
          if (e.propertyName === 'width' || e.propertyName === 'padding' || e.propertyName === 'border') {
            scheduleGridRelayout();
          }
        });
      }
    })();
    
    // Global tooltip logic: position a single fixed tooltip near hovered elements with `.has-tooltip`
    (function() {
      const tooltipEl = document.getElementById('globalTooltip');
      if (!tooltipEl) return;
      document.body.classList.add('tooltip-enhanced');

      let currentTarget = null;
      let hideTimer = null;

      function showTooltip(target) {
        const text = target.getAttribute('data-tooltip') || target.getAttribute('title');
        if (!text) return;
        tooltipEl.textContent = text;
        tooltipEl.setAttribute('aria-hidden', 'false');

        // Compute preferred position above the element; flip if needed
        const rect = target.getBoundingClientRect();
        const spacing = 8;
        const tooltipRect = tooltipEl.getBoundingClientRect();

        let x = rect.left + rect.width / 2 - tooltipRect.width / 2;
        let y = rect.top - tooltipRect.height - spacing;

        // Constrain within viewport
        const vw = document.documentElement.clientWidth;
        const vh = document.documentElement.clientHeight;
        if (x < 6) x = 6;
        if (x + tooltipRect.width > vw - 6) x = Math.max(6, vw - tooltipRect.width - 6);
        if (y < 6) {
          // Place below if not enough space above
          y = rect.bottom + spacing;
        }

        tooltipEl.style.transform = 'translateY(0)';
        tooltipEl.style.top = `${Math.round(y)}px`;
        tooltipEl.style.left = `${Math.round(x)}px`;
      }

      function hideTooltip() {
        tooltipEl.setAttribute('aria-hidden', 'true');
      }

      function handleEnter(e) {
        const target = e.target.closest('.has-tooltip');
        if (!target) return;
        if (currentTarget === target) {
          // Already showing for this target; just ensure visible and positioned
          clearTimeout(hideTimer);
          showTooltip(currentTarget);
          return;
        }
        currentTarget = target;
        // If element uses native title, suppress native bubble to avoid double tooltips
        if (currentTarget.hasAttribute('title')) {
          const t = currentTarget.getAttribute('title');
          if (t) currentTarget.setAttribute('data-tooltip', t);
          currentTarget.setAttribute('data-title-suppressed', 'true');
          currentTarget.setAttribute('title', '');
        }
        clearTimeout(hideTimer);
        showTooltip(currentTarget);
      }

      function handleMove(e) {
        if (!currentTarget) return;
        // Reposition on move to adapt near edges or when layout changes
        showTooltip(currentTarget);
      }

      function handleLeave(e) {
        if (!currentTarget) return;
        const leaving = e.target.closest('.has-tooltip');
        if (leaving !== currentTarget) return; // ignore leaves from other elements
        const related = e.relatedTarget;
        if (related && currentTarget.contains(related)) {
          // Still inside the same tooltip target; do not hide
          return;
        }
        hideTimer = setTimeout(() => {
          hideTooltip();
          // Restore title if we suppressed it
          if (currentTarget && currentTarget.getAttribute('data-title-suppressed') === 'true') {
            const text = currentTarget.getAttribute('data-tooltip');
            if (text) currentTarget.setAttribute('title', text);
            currentTarget.removeAttribute('data-title-suppressed');
          }
          currentTarget = null;
        }, 30);
      }

      // Use mouseover/mouseout for delegation (mouseenter/leave don't bubble)
      document.addEventListener('mouseover', handleEnter, true);
      document.addEventListener('focusin', handleEnter, true);
      document.addEventListener('mousemove', handleMove, true);
      document.addEventListener('mouseout', handleLeave, true);
      document.addEventListener('focusout', (e) => {
        if (!currentTarget) return;
        const leaving = e.target.closest('.has-tooltip');
        if (leaving !== currentTarget) return;
        hideTooltip();
        if (currentTarget && currentTarget.getAttribute('data-title-suppressed') === 'true') {
          const text = currentTarget.getAttribute('data-tooltip');
          if (text) currentTarget.setAttribute('title', text);
          currentTarget.removeAttribute('data-title-suppressed');
        }
        currentTarget = null;
      }, true);
      window.addEventListener('scroll', () => { if (currentTarget) showTooltip(currentTarget); }, true);
      window.addEventListener('resize', () => { if (currentTarget) showTooltip(currentTarget); });
    })();
  </script>
</body>
</html>
