<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- This meta tag makes the app responsive on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DXF Parser</title>
  <!-- Include JSZip for ZIP file browsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Load components in dependency order -->
  <script src="components/utils.js"></script>
  <script src="components/dxf-parser.js"></script>
  <script src="components/tree-data-grid.js"></script>
  <script src="components/batch-data-grid.js"></script>
  <script src="components/state-manager.js"></script>
  <script src="components/tree-diff-engine.js"></script>
  <script src="components/dxf-diagnostics-engine.js"></script>
  <script src="components/app.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="main-container">
    <!-- Top Header spanning sidebar and main content -->
    <div class="top-header">
      <div class="top-header-left">
        <button id="toggleSidebarBtn" class="sidebar-toggle" title="Show/Hide sidebar" aria-label="Toggle sidebar" aria-pressed="false">â˜°</button>
        <div class="app-title">DXF Parser</div>
        <span id="diffIndicator" class="diff-indicator" title="Tree Diff enabled" style="display:none;"></span>
      </div>
      <div class="top-header-right">
        <label>
          <input type="checkbox" id="useStreamCheckbox">
          Use Streamed Parsing
        </label>
        <button id="toggleRightPanelBtn" title="Show/Hide right panel">Toggle Right Panel</button>
        <button id="createNewDxfBtn">Create New</button>
        <button id="resetStateBtn" title="Reset state and close all tabs">Reset State</button>
      </div>
    </div>
    <!-- Main content wrapper with sidebar and main content -->
    <div class="content-wrapper">
      <!-- Sidebar: Contains logo, header buttons and filter panel -->
      <div class="sidebar">
        <div class="sidebar-buttons" style="grid-template-columns: 1fr;">
          <button id="showCloudOverlayBtn">Cloud Data</button>
          <button id="showStatsOverlayBtn">Statistics</button>
          <button id="showDepsOverlayBtn">Dependencies</button>
          <button id="showBinaryObjectsOverlayBtn">Binary Objects</button>
          <button id="showHandleMapOverlayBtn">Handle Map</button>
          <button id="showProxyObjectsOverlayBtn">Proxy Objects</button>
          <button id="showFontsOverlayBtn">Fonts Used</button>
          <button id="showClassesOverlayBtn">Classes</button>
          <button id="showObjectSizeOverlayBtn">Object Sizes</button>
          <button id="showBlocksOverlayBtn">Blocks & Inserts</button>
          <button id="showLineTypesOverlayBtn">Line Types</button>
          <button id="showTextsOverlayBtn">Texts</button>
          <button id="showDiagnosticsOverlayBtn">Diagnostics</button>
          <button id="showBatchProcessOverlayBtn">Batch Process</button>
        <button id="toggleSideBySideDiffBtn" title="Toggle side-by-side tree diff coloring">Tree Diff</button>
        </div>
        <div class="filter-panel" id="filterPanel" style="display:none;"></div>
      </div>
      <!-- Resizer between sidebar and main content -->
      <div class="pane-resizer"></div>
      <!-- Main Content Area -->
      <div class="main-content">
        <!-- Row: global controls and split load buttons -->
        <div id="rowControls" class="row-controls">
          <div class="row-controls-left">
            <button id="addRowBtn">Add Row</button>
            <button id="removeRowBtn">Remove Row</button>
            <button id="downloadDxfBtn">Download DXF</button>
            <button id="downloadTreeExcelBtn">Download Tree as Excel</button>
          </div>
          <div class="row-controls-right">
            <div id="navControls">
              <div id="handleNavBar">
                <input type="text" id="handleSearchInput" placeholder="Go to Handle">
                <button id="goToHandleBtn">Go</button>
              </div>
              <div id="navHistoryContainer">
                <div id="navHistoryControls">
                  <button id="backBtn" disabled>Back</button>
                  <button id="forwardBtn" disabled>Forward</button>
                  <button id="clearHistoryBtn">Clear</button>
                </div>
                <div id="navHistoryList"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- Two panel compare layout -->
        <div id="compareContainer" style="display:flex; gap: 8px; height: calc(100% - 60px);">
          <!-- Left Panel -->
          <div class="panel" id="panelLeft" style="flex:1; display:flex; flex-direction:column; min-width:0;">
            <div style="display:flex; align-items:center; gap:6px; margin: 0.25em 0;">
              <div id="tabContainerLeft" class="tab-container" style="flex:1; display:flex; flex-wrap:wrap; border-bottom:1px solid #ccc; margin:0.25em 0;"></div>
              <input type="file" id="fileInputLeft" accept=".dxf" multiple style="display:none">
              <button id="openLeftBtn" title="Open DXF on left">Open</button>
              <button id="expandAllLeftBtn" class="icon-button has-tooltip" title="Expand All" aria-label="Expand All" data-tooltip="Expand all nodes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 10l5 5 5-5H7z"/></svg>
              </button>
              <button id="collapseAllLeftBtn" class="icon-button has-tooltip" title="Collapse All" aria-label="Collapse All" data-tooltip="Collapse all nodes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 14l5-5 5 5H7z"/></svg>
              </button>
              <button id="filtersLeftBtn" class="icon-button filters-button has-tooltip" title="Filters" aria-label="Filters" data-tooltip="Open filters">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 5h18l-7 8v6l-4-2v-4L3 5z"/></svg>
              </button>
            </div>
            <div id="treeGridHeaderLeft" class="tree-header">
              <div class="tree-line header-cell flex-fixed" data-field="line" data-sort="none" style="width: 130px; text-align: left;">
                Line <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-code header-cell flex-fixed" data-field="code" data-sort="none" style="width: 100px; text-align: left;">
                Code <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-data header-cell flex-grow" data-field="type" data-sort="none" style="flex: 1;">
                Data <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-object-count header-cell flex-fixed" data-field="objectCount" data-sort="none" style="width: 130px; text-align: right;">
                Object Count <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-data-size header-cell flex-fixed" data-field="dataSize" data-sort="none" style="width: 130px; text-align: right;">
                Data Size <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
            </div>
            <div id="treeViewContainerLeft" style="position: relative; flex:1; overflow:auto; border:1px solid #ccc; clip-path: inset(0);">
              <div id="treeViewContentLeft" style="position: relative; overflow: hidden;"></div>
            </div>
          </div>
          <!-- Splitter between panels -->
          <div id="compareSplitter" class="compare-splitter" style="width:6px; cursor: ew-resize; background:#ccc; flex: none;"></div>
          <!-- Right Panel -->
          <div class="panel" id="panelRight" style="flex:1; display:flex; flex-direction:column; min-width:0;">
            <div style="display:flex; align-items:center; gap:6px; margin: 0.25em 0;">
              <div id="tabContainerRight" class="tab-container" style="flex:1; display:flex; flex-wrap:wrap; border-bottom:1px solid #ccc; margin:0.25em 0;"></div>
              <input type="file" id="fileInputRight" accept=".dxf" multiple style="display:none">
              <button id="openRightBtn" title="Open DXF on right">Open</button>
              <button id="expandAllRightBtn" class="icon-button has-tooltip" title="Expand All" aria-label="Expand All" data-tooltip="Expand all nodes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 10l5 5 5-5H7z"/></svg>
              </button>
              <button id="collapseAllRightBtn" class="icon-button has-tooltip" title="Collapse All" aria-label="Collapse All" data-tooltip="Collapse all nodes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 14l5-5 5 5H7z"/></svg>
              </button>
              <button id="filtersRightBtn" class="icon-button filters-button has-tooltip" title="Filters" aria-label="Filters" data-tooltip="Open filters">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 5h18l-7 8v6l-4-2v-4L3 5z"/></svg>
              </button>
            </div>
            <div id="treeGridHeaderRight" class="tree-header">
              <div class="tree-line header-cell flex-fixed" data-field="line" data-sort="none" style="width: 130px; text-align: left;">
                Line <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-code header-cell flex-fixed" data-field="code" data-sort="none" style="width: 100px; text-align: left;">
                Code <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-data header-cell flex-grow" data-field="type" data-sort="none" style="flex: 1;">
                Data <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-object-count header-cell flex-fixed" data-field="objectCount" data-sort="none" style="width: 130px; text-align: right;">
                Object Count <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
              <div class="tree-data-size header-cell flex-fixed" data-field="dataSize" data-sort="none" style="width: 130px; text-align: right;">
                Data Size <span class="sort-indicator"></span>
                <div class="resizer"></div>
              </div>
            </div>
            <div id="treeViewContainerRight" style="position: relative; flex:1; overflow:auto; border:1px solid #ccc; clip-path: inset(0);">
              <div id="treeViewContentRight" style="position: relative; overflow: hidden;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Filters Popup Overlay (Left) -->
  <div id="filtersOverlayLeft" class="filters-overlay" style="display:none;">
    <div class="overlay-content" style="max-width: 520px; max-height: 90vh; overflow:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Filters (Left Tab)</h2>
        <button id="closeFiltersOverlayLeft">Close</button>
      </div>
      <div class="filter-content">
        <div class="filter-row">
          <div id="codeSearchTagsLeft" class="tag-container">
            <input type="text" id="codeSearchInputLeft" placeholder="Search by Code">
          </div>
        </div>
        <div class="filter-row">
          <div id="dataSearchTagsLeft" class="tag-container">
            <input type="text" id="dataSearchInputLeft" placeholder="Search by Data value">
          </div>
        </div>
        <div class="filter-row">
          <label>Object Types:</label>
          <div id="objectTypeDropdownLeft" class="dropdown">
            <button id="objectTypeDropdownButtonLeft">All Types</button>
            <div id="objectTypeDropdownContentLeft" class="dropdown-content"></div>
          </div>
        </div>
        <div class="filter-row">
          <label><input type="checkbox" id="dataExactCheckboxLeft"> Exact Data Match</label>
        </div>
        <div class="filter-row">
          <label><input type="checkbox" id="dataCaseCheckboxLeft"> Case Sensitive</label>
        </div>
        <div class="filter-row">
          <label for="minLineInputLeft">Min Line:</label>
          <input type="number" id="minLineInputLeft" style="width:80px;">
        </div>
        <div class="filter-row">
          <label for="maxLineInputLeft">Max Line:</label>
          <input type="number" id="maxLineInputLeft" style="width:80px;">
        </div>
        <div class="filter-row">
          <button id="searchBtnLeft">Apply</button>
          <button id="clearSearchBtnLeft">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Popup Overlay (Right) -->
  <div id="filtersOverlayRight" class="filters-overlay" style="display:none;">
    <div class="overlay-content" style="max-width: 520px; max-height: 90vh; overflow:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Filters (Right Tab)</h2>
        <button id="closeFiltersOverlayRight">Close</button>
      </div>
      <div class="filter-content">
        <div class="filter-row">
          <div id="codeSearchTagsRight" class="tag-container">
            <input type="text" id="codeSearchInputRight" placeholder="Search by Code">
          </div>
        </div>
        <div class="filter-row">
          <div id="dataSearchTagsRight" class="tag-container">
            <input type="text" id="dataSearchInputRight" placeholder="Search by Data value">
          </div>
        </div>
        <div class="filter-row">
          <label>Object Types:</label>
          <div id="objectTypeDropdownRight" class="dropdown">
            <button id="objectTypeDropdownButtonRight">All Types</button>
            <div id="objectTypeDropdownContentRight" class="dropdown-content"></div>
          </div>
        </div>
        <div class="filter-row">
          <label><input type="checkbox" id="dataExactCheckboxRight"> Exact Data Match</label>
        </div>
        <div class="filter-row">
          <label><input type="checkbox" id="dataCaseCheckboxRight"> Case Sensitive</label>
        </div>
        <div class="filter-row">
          <label for="minLineInputRight">Min Line:</label>
          <input type="number" id="minLineInputRight" style="width:80px;">
        </div>
        <div class="filter-row">
          <label for="maxLineInputRight">Max Line:</label>
          <input type="number" id="maxLineInputRight" style="width:80px;">
        </div>
        <div class="filter-row">
          <button id="searchBtnRight">Apply</button>
          <button id="clearSearchBtnRight">Clear</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Overlays -->
  <div id="cloudOverlay">
    <div class="overlay-content">
      <button id="closeCloudOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="cloudOverlay">Back to Tree</button>
      <h2>Cloud Data</h2>
      <h3>Object Cloud</h3>
      <div id="overlayObjectCloud"></div>
      <h3>Code Cloud</h3>
      <div id="overlayCodeCloud"></div>
    </div>
  </div>
  <div id="statsOverlay">
    <div class="overlay-content">
      <button id="closeStatsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="statsOverlay">Back to Tree</button>
      <h2>DXF Statistics</h2>
      <div id="overlayStatsContent"></div>
    </div>
  </div>
  <div id="depsOverlay">
    <div class="overlay-content">
      <button id="closeDepsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="depsOverlay">Back to Tree</button>
      <h2>DXF Dependencies</h2>
      <div id="overlayDepsContent"></div>
    </div>
  </div>
  <div id="hexViewerOverlay">
    <div class="overlay-content">
      <button id="closeHexViewerOverlay">Close</button>
      <button id="saveBinaryBtn">Save Binary</button>
      <button id="previewImageBtn">Preview Image</button>
      <h2>Hex Viewer</h2>
      <div id="headerInfo"></div>
      <pre id="hexContent" style="overflow:auto; height: calc(100% - 160px);"></pre>
      <div id="imagePreviewContainer"></div>
      <div id="zipContentsContainer"></div>
    </div>
  </div>
  <div id="binaryObjectsOverlay">
    <div class="overlay-content">
      <button id="closeBinaryObjectsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="binaryObjectsOverlay">Back to Tree</button>
      <h2>Binary Data Objects</h2>
      <div id="binaryObjectsList"></div>
    </div>
  </div>
  <div id="handleMapOverlay">
    <div class="overlay-content">
      <button id="closeHandleMapOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="handleMapOverlay">Back to Tree</button>
      <h2>DXF Handle Map</h2>
      <div id="overlayHandleMapContent"></div>
    </div>
  </div>
  <div id="proxyObjectsOverlay">
    <div class="overlay-content">
      <button id="closeProxyObjectsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="proxyObjectsOverlay">Back to Tree</button>
      <h2>Proxy Objects</h2>
      <div id="proxyObjectsList"></div>
    </div>
  </div>
  <div id="fontsOverlay">
    <div class="overlay-content">
      <button id="closeFontsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="fontsOverlay">Back to Tree</button>
      <h2>Fonts Used in DXF</h2>
      <div id="overlayFontsContent"></div>
    </div>
  </div>
  <div id="classesOverlay">
    <div class="overlay-content">
      <button id="closeClassesOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="classesOverlay">Back to Tree</button>
      <h2>DXF Classes</h2>
      <div id="overlayClassesContent"></div>
    </div>
  </div>
  <div id="diagnosticsOverlay">
    <div class="overlay-content">
      <div class="diagnostics-header">
        <div class="diagnostics-header-left">
          <h2>DXF Comprehensive Diagnostics</h2>
          <button id="configureRulesBtn">Configure Rules</button>
        </div>
        <div class="diagnostics-header-right">
          <button id="runDiagnosticsBtn">Run Analysis</button>
          <button id="exportDiagnosticsBtn">Export Report</button>
          <button id="closeDiagnosticsOverlay">Close</button>
        </div>
      </div>
      
      <div class="diagnostics-progress" id="diagnosticsProgress" style="display:none;">
        <div class="diagnostics-progress-bar">
          <div class="diagnostics-progress-fill" id="diagnosticsProgressFill" style="width: 0%;"></div>
        </div>
        <div id="diagnosticsProgressText">Initializing diagnostics...</div>
      </div>

      <div class="diagnostics-summary" id="diagnosticsSummary" style="display:none;">
        <div class="diagnostics-stats" id="diagnosticsStats"></div>
        
        <!-- Advanced Search and Filtering -->
        <div class="diagnostics-filters" id="diagnosticsFilters">
          <div class="diagnostics-filter-row">
            <div class="diagnostics-search-container">
              <input type="text" id="diagnosticsSearchInput" placeholder="Search issues... (Ctrl+F)" title="Search in issue titles and descriptions. Use Ctrl+F to focus, Escape to clear." />
              <button id="clearDiagnosticsSearch" title="Clear search">Clear</button>
            </div>
            <div class="diagnostics-severity-filters">
              <label title="Press 1 to filter Critical issues only"><input type="checkbox" id="filterCritical" checked> Critical</label>
              <label title="Press 2 to filter Error issues only"><input type="checkbox" id="filterError" checked> Error</label>
              <label title="Press 3 to filter Warning issues only"><input type="checkbox" id="filterWarning" checked> Warning</label>
              <label title="Press 4 to filter Info issues only"><input type="checkbox" id="filterInfo" checked> Info</label>
              <label title="Press 5 to filter Suggestion issues only"><input type="checkbox" id="filterSuggestion" checked> Suggestion</label>
            </div>
            <div class="diagnostics-category-filters">
              <select id="diagnosticsCategoryFilter" title="Filter by diagnostic category">
                <option value="">All Categories</option>
                <option value="structural">Structural Issues</option>
                <option value="integrity">Data Integrity</option>
                <option value="rendering">Rendering</option>
                <option value="text">Text</option>
                <option value="performance">Performance</option>
                <option value="compliance">DXF Compliance</option>
                <option value="best-practices">Best Practices</option>
                <option value="security">Security</option>
              </select>
            </div>
          </div>
                <div class="diagnostics-help-text" style="font-size: 0.8em; color: #666; margin-top: 0.5em;">
        ðŸ’¡ <strong>Quick Tips:</strong> Ctrl+F to search, 1-5 keys for severity filters, Ctrl+E to export, click statistics to filter by severity
      </div>
    </div>


      <div class="diagnostics-tabs" id="diagnosticsTabs">
        <div class="diagnostics-tab active" data-tab="overview">Overview</div>
        <div class="diagnostics-tab" data-tab="structural">Structural Issues</div>
        <div class="diagnostics-tab" data-tab="integrity">Data Integrity</div>
        <div class="diagnostics-tab" data-tab="rendering">Rendering</div>
        <div class="diagnostics-tab" data-tab="text">Text</div>
        <div class="diagnostics-tab" data-tab="performance">Performance</div>
        <div class="diagnostics-tab" data-tab="compliance">DXF Compliance</div>
        <div class="diagnostics-tab" data-tab="best-practices">Best Practices</div>
        <div class="diagnostics-tab" data-tab="security">Security</div>
      </div>

      <div id="diagnosticsTabContent">
        <div class="diagnostics-content active" id="diagnostics-overview">
          <div id="diagnosticsOverviewContent">
            <p>Click "Run Analysis" to start comprehensive DXF diagnostics analysis...</p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-structural">
          <div id="diagnosticsStructuralContent">
            <p><em>No structural issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-integrity">
          <div id="diagnosticsIntegrityContent">
            <p><em>No data integrity issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-rendering">
          <div id="diagnosticsRenderingContent">
            <p><em>No rendering issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-text">
          <div id="diagnosticsTextContent">
            <p><em>No text issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-performance">
          <div id="diagnosticsPerformanceContent">
            <p><em>No performance issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-compliance">
          <div id="diagnosticsComplianceContent">
            <p><em>No compliance issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-best-practices">
          <div id="diagnosticsBestPracticesContent">
            <p><em>No best practice violations found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
        
        <div class="diagnostics-content" id="diagnostics-security">
          <div id="diagnosticsSecurityContent">
            <p><em>No security issues found yet. Click "Run Analysis" to begin diagnostics...</em></p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Rule Configuration Dialog - Separate overlay rendered above diagnostics -->
  <div id="ruleConfigOverlay">
    <div class="overlay-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; margin: 20px auto;">
      <div class="overlay-header">
        <h2>Configure Diagnostic Rules</h2>
        <button class="close-overlay" id="closeRuleConfigBtn">&times;</button>
      </div>
      
      <div class="rule-config-toolbar">
        <div class="rule-config-actions">
          <button id="selectAllRulesBtn">Select All</button>
          <button id="deselectAllRulesBtn">Deselect All</button>
          <button id="resetToDefaultRulesBtn">Reset to Default</button>
        </div>
        
        <div class="rule-profiles">
          <select id="ruleProfileSelect">
            <option value="">Select Profile...</option>
          </select>
          <button id="saveRuleProfileBtn">Save Profile</button>
          <button id="loadRuleProfileBtn">Load Profile</button>
          <button id="deleteRuleProfileBtn">Delete Profile</button>
          <button id="clearAllProfilesBtn">Clear All Profiles</button>
          <button id="saveProfileToFileBtn">Save to File</button>
          <button id="loadProfileFromFileBtn">Load from File</button>
          <input type="file" id="profileFileInput" accept=".json" style="display: none;">
        </div>
        
        <div class="rule-search">
          <input type="text" id="ruleSearchInput" placeholder="Search rules..." />
        </div>
      </div>
      
      <div class="rule-config-content" id="ruleConfigContent">
        <!-- Rule categories will be populated dynamically -->
      </div>
      
      <div class="overlay-footer">
        <button id="applyRuleConfigBtn" class="primary">Apply Configuration</button>
        <button id="cancelRuleConfigBtn">Cancel</button>
      </div>
    </div>
  </div>
</div>
  
  <div id="objectSizeOverlay">
    <div class="overlay-content">
      <button id="closeObjectSizeOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="objectSizeOverlay">Back to Tree</button>
      <h2>Object Sizes</h2>
      <!-- The container that will be virtualized -->
      <div id="objectSizeList" style="overflow-y:auto; height: calc(100% - 60px); border:1px solid #ccc; margin-top:40px;"></div>
    </div>
  </div>
  <div id="blocksOverlay">
    <div class="overlay-content">
      <button id="closeBlocksOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="blocksOverlay">Back to Tree</button>
      <h2>Block &amp; Insert Relations</h2>
      <div id="overlayBlocksContent"></div>
    </div>
  </div>
  <div id="lineTypesOverlay">
    <div class="overlay-content">
      <button id="closeLineTypesOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="lineTypesOverlay">Back to Tree</button>
      <h2>DXF Line Types</h2>
      <div id="overlayLineTypesContent"></div>
    </div>
  </div>
  <div id="textsOverlay">
    <div class="overlay-content">
      <button id="closeTextsOverlay">Close</button>
      <button class="backToTreeBtn" data-overlay="textsOverlay">Back to Tree</button>
      <h2>DXF Texts</h2>
      <div id="overlayTextsContent"></div>
    </div>
  </div>
  <div id="batchProcessingOverlay">
    <div class="overlay-content" style="display: flex; flex-direction: column; gap: 0.5em; position: relative;">
      <!-- Close Button -->
      <button id="closeBatchOverlay">Close</button>
      <!-- Title -->
      <h2 style="margin: 0;">Batch Process DXF Files</h2>

      <!-- Search Options: compact grid layout -->
      <div class="batch-search-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em; margin: 0;">
        <!-- Full-width row for directory input -->
        <div style="grid-column: 1 / -1;">
          <label>Select Root Directory:
            <input type="file" id="directoryInput" webkitdirectory directory multiple>
          </label>
        </div>
        <!-- Two-column row: Object Type and Search Code -->
        <div>
          <label>Object Type:
            <input type="text" id="batchObjectType" placeholder="e.g. LINE, CIRCLE">
          </label>
        </div>
        <div>
          <label>Search Code:
            <input type="text" id="batchSearchCode" placeholder="DXF code (optional)">
          </label>
        </div>
        <!-- Two-column row: Search Data and Search Mode -->
        <div>
          <label>Search Data:
            <input type="text" id="batchSearchText" placeholder="Enter search text">
          </label>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5em;">
          <label>
            <input type="radio" name="batchSearchMode" value="contains" checked>
            Contains
          </label>
          <label>
            <input type="radio" name="batchSearchMode" value="exact">
            Exact
          </label>
        </div>

        <!-- Predefined Query Templates Dropdown -->
        <div style="grid-column: 1 / -1;">
          <label>Predefined Query Templates:
            <select id="batchPredefinedQuery">
              <option value="">--Select Template--</option>
              <option value="node => true">All Nodes</option>
              <option value="node => node.type === 'LINE'">All Lines</option>
              <option value="node => node.properties && node.properties.some(p => String(p.code) === '310')">
                Nodes with Code 310
              </option>
              <option value="node => ! (node.properties && node.properties.some(p => String(p.code) === '310'))">
                Nodes without Code 310
              </option>
              <option value="node => (node.type === 'CIRCLE' || node.type === 'ARC')">
                Circles or Arcs
              </option>
              <!-- Filter nodes whose type matches a regex (case-insensitive) -->
              <option value="node => /LINE/i.test(node.type)">
                Nodes with type matching /LINE/i
              </option>
              <!-- Filter nodes that have children with a specific type -->
              <option value="node => node.children && node.children.some(child => child.type === 'BLOCK')">
                Nodes with a Child of type 'BLOCK'
              </option>
              <!-- Filter nodes where any property value matches a regex -->
              <option value="node => node.properties && node.properties.some(p => /circle/i.test(p.value))">
                Nodes with property value matching /circle/i
              </option>
              <!-- Filter nodes that have a child whose property code '2' equals 'INSERT' -->
              <option value="node => node.children && node.children.some(child => child.properties && child.properties.some(p => String(p.code) === '2' && p.value === 'INSERT'))">
                Nodes with Child having property 2 equal to 'INSERT'
              </option>
            </select>
          </label>
        </div>

        <!-- JS Query Input Field -->
        <div style="grid-column: 1 / -1;">
          <label>JavaScript Query:
            <input type="text" id="batchJsQuery" placeholder="e.g. node => node.type === 'LINE'" style="width:100%;">
          </label>
        </div>

        <!-- Full-width row for Start button and progress bar -->
        <div style="grid-column: 1 / -1; display: flex; flex-direction: column; gap: 0.5em;">
          <button id="startBatchProcess">Start Batch Process</button>
          <progress id="batchProgress" value="0" max="100" style="width: 100%; display: none;"></progress>
        </div>
      </div>

      <hr style="margin: 0;">

      <!-- Results Section -->
      <h3 style="margin: 0;">Results</h3>
      <div id="batchResultsTabs" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
        <div id="batchResultsTabHeaders" style="display: flex; border-bottom: 1px solid #ccc;"></div>
        <div id="batchResultsTabContents" style="flex: 1; overflow: auto;"></div>
      </div>

      <!-- Download Button -->
      <div style="text-align: center; margin-top: 0.5em;">
        <button id="downloadExcelBtn">Download as Excel</button>
      </div>
    </div>
  </div>
  

  <!-- Context Menu root (built dynamically in JS) -->
  <nav id="contextMenu" class="menu" role="menu" aria-hidden="true"></nav>

  <!-- Utility Functions -->
  <!-- JavaScript Classes -->
  <!-- TreeDataGrid Control -->
  <!-- BatchDataGrid Control -->
  <!-- Application Code -->
  <script>
    (function() {
      const contentWrapper = document.querySelector('.content-wrapper');
      const toggleBtn = document.getElementById('toggleSidebarBtn');
      if (!contentWrapper || !toggleBtn) return;

      const sidebarEl = document.querySelector('.sidebar');

      function scheduleGridRelayout() {
        // Prefer calling the app grid directly; fallback to a window resize event
        const run = () => {
          if (window.app) {
            // Run twice to ensure after layout settles
            if (window.app.myTreeGridLeft) {
              window.app.myTreeGridLeft.updateVisibleNodes();
              requestAnimationFrame(() => window.app.myTreeGridLeft.updateVisibleNodes());
            }
            if (window.app.myTreeGridRight) {
              window.app.myTreeGridRight.updateVisibleNodes();
              requestAnimationFrame(() => window.app.myTreeGridRight.updateVisibleNodes());
            }
          } else {
            window.dispatchEvent(new Event('resize'));
          }
        };
        // Give CSS transitions a moment to complete
        setTimeout(run, 0);
        setTimeout(run, 200);
      }

      function setSidebarCollapsed(collapsed) {
        if (collapsed) {
          contentWrapper.classList.add('sidebar-collapsed');
          toggleBtn.setAttribute('aria-pressed', 'true');
        } else {
          contentWrapper.classList.remove('sidebar-collapsed');
          toggleBtn.setAttribute('aria-pressed', 'false');
        }
        try { localStorage.setItem('sidebarCollapsed', String(collapsed)); } catch (e) {}
        scheduleGridRelayout();
      }

      // Initialize from saved state (migrate old key if present)
      const savedCollapsed = (function() {
        try {
          const legacyHidden = localStorage.getItem('sidebarHidden') === 'true';
          const newCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
          return newCollapsed || legacyHidden;
        } catch (e) { return false; }
      })();
      setSidebarCollapsed(savedCollapsed);

      // Toggle handler
      toggleBtn.addEventListener('click', function(){
        const willCollapse = !contentWrapper.classList.contains('sidebar-collapsed');
        setSidebarCollapsed(willCollapse);
      });

      // Also relayout on the end of the sidebar width transition
      if (sidebarEl) {
        sidebarEl.addEventListener('transitionend', (e) => {
          if (e.propertyName === 'width' || e.propertyName === 'padding' || e.propertyName === 'border') {
            scheduleGridRelayout();
          }
        });
      }
    })();
  </script>
</body>
</html>
